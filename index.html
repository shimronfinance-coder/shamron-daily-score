<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.json" />
  <title>Shamron Daily Score</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b1220; color:#e9eefc; }
    body { margin:0; padding:16px; max-width:980px; margin-inline:auto; }
    .row { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width:900px){ .row { grid-template-columns: 1.2fr 0.8fr; } }
    .card { background:#121a2c; border:1px solid #223052; border-radius:16px; padding:14px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    h1 { margin:8px 0 2px; font-size:22px; }
    .muted { color:#a9b6da; font-size:13px; line-height:1.4; }
    label { display:block; margin:10px 0 6px; font-weight:600; }
    input[type="range"] { width:100%; }
    textarea, input[type="text"] { width:100%; box-sizing:border-box; padding:10px; border-radius:12px; border:1px solid #2b3a66; background:#0e1526; color:#e9eefc; }
    textarea { min-height:90px; resize:vertical; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#0e1526; border:1px solid #2b3a66; font-size:13px; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button { cursor:pointer; border:0; padding:10px 12px; border-radius:12px; background:#2a66ff; color:white; font-weight:700; }
    button.secondary { background:#223052; }
    button.danger { background:#d64545; }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .big { font-size:38px; font-weight:900; letter-spacing:-1px; }
    .grade { font-size:18px; font-weight:800; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    td, th { border-bottom:1px solid #223052; padding:8px; text-align:right; vertical-align:top; }
    canvas { width:100%; height:160px; background:#0e1526; border:1px solid #2b3a66; border-radius:12px; }
    .hint { font-size:12px; color:#a9b6da; margin-top:6px; }
    .warn { color:#ffd27a; }
  </style>
</head>
<body>
  <h1>Shamron Daily Score</h1>
  <div class="muted">שאלון יומי שמוציא ציון 0-100, המלצות, ושומר היסטוריה (אופליין). המטרה: עקביות, חדות, כסף, שליטה עצמית.</div>

  <div class="row" style="margin-top:12px;">
    <div class="card">
      <div class="kpi">
        <span class="pill">תאריך: <b id="dateLabel"></b></span>
        <span class="pill">ממוצע 7 ימים: <b id="avg7">-</b></span>
        <span class="pill">ימים רצופים: <b id="streak">-</b></span>
      </div>

      <label>שינה (שעות)</label>
      <input id="sleepHours" type="range" min="0" max="10" step="0.5" value="6.5">
      <div class="muted">נוכחי: <b id="sleepHoursVal"></b></div>

      <div class="grid2">
        <div>
          <label>אנרגיה כללית (0-10)</label>
          <input id="energy" type="range" min="0" max="10" step="1" value="6">
          <div class="muted">נוכחי: <b id="energyVal"></b></div>
        </div>
        <div>
          <label>מצב רוח (0-10)</label>
          <input id="mood" type="range" min="0" max="10" step="1" value="6">
          <div class="muted">נוכחי: <b id="moodVal"></b></div>
        </div>
      </div>

      <label>Deep Work אמיתי (דקות נטו)</label>
      <input id="deepWork" type="range" min="0" max="480" step="15" value="180">
      <div class="muted">נוכחי: <b id="deepWorkVal"></b></div>

      <div class="grid2">
        <div>
          <label>AI Mastery (דקות)</label>
          <input id="aiMinutes" type="range" min="0" max="240" step="15" value="60">
          <div class="muted">נוכחי: <b id="aiMinutesVal"></b></div>
        </div>
        <div>
          <label>בנייה לכסף (מוצר/קורס/הצעת ערך) (דקות)</label>
          <input id="moneyMinutes" type="range" min="0" max="240" step="15" value="60">
          <div class="muted">נוכחי: <b id="moneyMinutesVal"></b></div>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>טיקטוק - יצירה/צילום/עריכה (דקות)</label>
          <input id="contentMinutes" type="range" min="0" max="180" step="15" value="45">
          <div class="muted">נוכחי: <b id="contentMinutesVal"></b></div>
        </div>
        <div>
          <label>דיבור למצלמה - אימון/חזרות (דקות)</label>
          <input id="speakingMinutes" type="range" min="0" max="60" step="5" value="10">
          <div class="muted">נוכחי: <b id="speakingMinutesVal"></b></div>
        </div>
      </div>

      <label>אנגלית (דקות)</label>
      <input id="englishMinutes" type="range" min="0" max="180" step="15" value="60">
      <div class="muted">נוכחי: <b id="englishMinutesVal"></b></div>

      <div class="grid2">
        <div>
          <label>בריחות / רשתות לא-עבודה (דקות)</label>
          <input id="distractionMinutes" type="range" min="0" max="240" step="10" value="40">
          <div class="muted">נוכחי: <b id="distractionMinutesVal"></b></div>
          <div class="hint warn">כאן אתה קונה או מאבד חיים.</div>
        </div>
        <div>
          <label>שליטה עצמית היום (0-10)</label>
          <input id="selfControl" type="range" min="0" max="10" step="1" value="6">
          <div class="muted">נוכחי: <b id="selfControlVal"></b></div>
        </div>
      </div>

      <label>הדבר הכי חשוב שקידם אותך היום (שורה אחת)</label>
      <input id="win" type="text" placeholder="לדוגמה: 2 שעות Deep Work על מבנה הקורס + סרטון דיבור חד">

      <label>איפה נשברת / מה גרם לבריחה?</label>
      <textarea id="break"></textarea>

      <label>מטרה אחת ליום מחר (חדה וקטנה)</label>
      <input id="tomorrow" type="text" placeholder="לדוגמה: לבנות מודול 1 + לצלם סרטון אחד בלי חזרות">

      <div class="btns">
        <button id="calcBtn">חשב ציון ושמור</button>
        <button class="secondary" id="loadBtn">טען את היום הזה</button>
        <button class="secondary" id="exportBtn">ייצוא CSV</button>
        <button class="danger" id="resetBtn">מחיקת כל הנתונים</button>
      </div>
      <div class="hint">טיפ: תעשה את זה כל ערב בשעה קבועה. עקביות > שלמות.</div>
    </div>

    <div class="card">
      <div class="muted">תוצאה יומית</div>
      <div class="big" id="scoreBig">-</div>
      <div class="grade" id="grade">-</div>
      <div class="muted" id="summary"></div>

      <div style="margin-top:12px;">
        <div class="muted">גרף 14 ימים אחרונים</div>
        <canvas id="chart" width="600" height="160"></canvas>
      </div>

      <div style="margin-top:12px;">
        <div class="muted">המלצות אוטומטיות</div>
        <ul id="tips"></ul>
      </div>

      <div style="margin-top:12px;">
        <div class="muted">היסטוריה (10 אחרונים)</div>
        <div id="history"></div>
      </div>
    </div>
  </div>

<script>
  // --- PWA SW ---
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
  }

  // --- Helpers ---
  const $ = (id) => document.getElementById(id);
  const todayISO = () => new Date().toISOString().slice(0,10);

  const KEY = "shamron_daily_score_v1";
  const loadAll = () => JSON.parse(localStorage.getItem(KEY) || "{}");
  const saveAll = (obj) => localStorage.setItem(KEY, JSON.stringify(obj));

  const clamp = (x, a, b) => Math.max(a, Math.min(b, x));

  function gradeFromScore(s){
    if (s >= 90) return "A+ (אליטה)";
    if (s >= 80) return "A (חזק)";
    if (s >= 70) return "B (טוב, אפשר לדייק)";
    if (s >= 60) return "C (בינוני - לא מספיק למטרות שלך)";
    return "D (סטייה מהמסלול)";
  }

  // Normalize helpers: map value to 0..1 with soft caps
  const normMinutes = (m, target) => clamp(m / target, 0, 1);
  const normRange10 = (v) => clamp(v / 10, 0, 1);

  function computeScore(data){
    // Weights tuned to your goals: כסף + חדות + AI + שליטה עצמית
    // Total positive weights = 100
    const w = {
      sleep: 10,
      energy: 6,
      mood: 4,
      deepWork: 20,
      ai: 15,
      money: 18,
      content: 8,
      speaking: 4,
      english: 10,
      selfControl: 10,
      // distraction is penalty up to -15
      distractionPenaltyMax: 15
    };

    // targets
    const t = {
      sleepHours: 7.5,
      deepWorkMin: 240,      // 4h
      aiMin: 90,
      moneyMin: 90,
      contentMin: 45,
      speakingMin: 10,
      englishMin: 120,
      distractionMax: 30     // minutes (soft)
    };

    // Sleep scoring: best around 7.5-8.5, lower reduces
    const sleepScore = clamp(data.sleepHours / t.sleepHours, 0, 1);

    const deepScore = normMinutes(data.deepWork, t.deepWorkMin);
    const aiScore = normMinutes(data.aiMinutes, t.aiMin);
    const moneyScore = normMinutes(data.moneyMinutes, t.moneyMin);
    const contentScore = normMinutes(data.contentMinutes, t.contentMin);
    const speakingScore = normMinutes(data.speakingMinutes, t.speakingMin);
    const englishScore = normMinutes(data.englishMinutes, t.englishMin);

    const pos =
      w.sleep * sleepScore +
      w.energy * normRange10(data.energy) +
      w.mood * normRange10(data.mood) +
      w.deepWork * deepScore +
      w.ai * aiScore +
      w.money * moneyScore +
      w.content * contentScore +
      w.speaking * speakingScore +
      w.english * englishScore +
      w.selfControl * normRange10(data.selfControl);

    // Penalty: if distractions exceed max, scale penalty
    const distractionOver = Math.max(0, data.distractionMinutes - t.distractionMax);
    const penalty = clamp(distractionOver / 120, 0, 1) * w.distractionPenaltyMax;

    const score = Math.round(clamp(pos - penalty, 0, 100));
    return { score, penalty: Math.round(penalty), components: {sleepScore, deepScore, aiScore, moneyScore, contentScore, speakingScore, englishScore} };
  }

  function tipsFromData(data, meta){
    const tips = [];

    if (data.distractionMinutes > 60) tips.push("מחר: חוסם רשתות 2 בלוקים של 90 דק. בלי טלפון. אחרת אתה משלם באוגוסט ובעתיד.");
    if (data.deepWork < 180) tips.push("Deep Work נמוך: מחר 2 בלוקים של 90 דק על כסף/AI לפני כל דבר.");
    if (data.moneyMinutes < 60) tips.push("לא בנית כסף מספיק: מחר שעה ראשונה מוקדשת אך ורק למוצר/קורס (מבנה/מודול/דף מכירה).");
    if (data.aiMinutes < 45) tips.push("AI Mastery נמוך: מחר 45 דק של תרגול אמיתי - תבנה Workflow, לא עוד קריאה.");
    if (data.englishMinutes < 60) tips.push("אנגלית נמוכה: מחר 20 מילים + 10 דק דיבור בקול רם + 30 דק Reading.");
    if (data.speakingMinutes < 10) tips.push("דיבור חלש: מחר 2 דקות מונולוג בלי לעצור + צילום טייק אחד. בלי חזרות.");
    if (data.sleepHours < 6.5) tips.push("שינה נמוכה: אתה לא רובוט. מחר שינה 7.5 שעות. זו השקעה בציון ובכסף.");
    if (data.selfControl < 6) tips.push("שליטה עצמית נמוכה: מחר 3 דקות נשימה/הליכה קצרה ברגע שאתה מרגיש עצבים. לא מו\"מ.");
    if (tips.length === 0) tips.push("יום נקי. מחר משכפל את זה ומעלה 10% - יותר כסף/יותר Deep Work.");

    // Add a focused "one move" recommendation
    let oneMove = "מהלך אחד למחר: ";
    if (data.moneyMinutes < 90) oneMove += "להוציא תוצר אחד שמקרב למכירה (עמוד נחיתה / סילבוס / מודול 1).";
    else if (data.deepWork < 240) oneMove += "2 בלוקים Deep Work בלי טלפון.";
    else oneMove += "לצלם סרטון אחד חד + לעבוד שעה על שדרוג ההצעה.";
    tips.unshift(oneMove);

    return tips;
  }

  function setValLabel(rangeId, labelId, suffix=""){
    const el = $(rangeId);
    const out = $(labelId);
    const update = () => out.textContent = el.value + suffix;
    el.addEventListener("input", update);
    update();
  }

  function getFormData(){
    return {
      date: currentDate,
      sleepHours: parseFloat($("sleepHours").value),
      energy: parseInt($("energy").value, 10),
      mood: parseInt($("mood").value, 10),
      deepWork: parseInt($("deepWork").value, 10),
      aiMinutes: parseInt($("aiMinutes").value, 10),
      moneyMinutes: parseInt($("moneyMinutes").value, 10),
      contentMinutes: parseInt($("contentMinutes").value, 10),
      speakingMinutes: parseInt($("speakingMinutes").value, 10),
      englishMinutes: parseInt($("englishMinutes").value, 10),
      distractionMinutes: parseInt($("distractionMinutes").value, 10),
      selfControl: parseInt($("selfControl").value, 10),
      win: $("win").value.trim(),
      break: $("break").value.trim(),
      tomorrow: $("tomorrow").value.trim(),
      savedAt: new Date().toISOString()
    };
  }

  function fillForm(d){
    $("sleepHours").value = d.sleepHours ?? 6.5;
    $("energy").value = d.energy ?? 6;
    $("mood").value = d.mood ?? 6;
    $("deepWork").value = d.deepWork ?? 180;
    $("aiMinutes").value = d.aiMinutes ?? 60;
    $("moneyMinutes").value = d.moneyMinutes ?? 60;
    $("contentMinutes").value = d.contentMinutes ?? 45;
    $("speakingMinutes").value = d.speakingMinutes ?? 10;
    $("englishMinutes").value = d.englishMinutes ?? 60;
    $("distractionMinutes").value = d.distractionMinutes ?? 40;
    $("selfControl").value = d.selfControl ?? 6;
    $("win").value = d.win ?? "";
    $("break").value = d.break ?? "";
    $("tomorrow").value = d.tomorrow ?? "";
    // refresh labels
    ["sleepHours","energy","mood","deepWork","aiMinutes","moneyMinutes","contentMinutes","speakingMinutes","englishMinutes","distractionMinutes","selfControl"]
      .forEach(id => $(""+id).dispatchEvent(new Event("input")));
  }

  function renderHistory(all){
    const entries = Object.values(all).sort((a,b)=> a.date.localeCompare(b.date));
    const last = entries.slice(-10).reverse();
    if (last.length === 0) { $("history").innerHTML = "<div class='muted'>אין נתונים עדיין.</div>"; return; }
    let html = "<table><thead><tr><th>תאריך</th><th>ציון</th><th>ניצחון</th></tr></thead><tbody>";
    for (const e of last){
      html += `<tr><td>${e.date}</td><td><b>${e.score}</b></td><td>${(e.win||"").slice(0,60)}</td></tr>`;
    }
    html += "</tbody></table>";
    $("history").innerHTML = html;
  }

  function renderChart(all){
    const c = $("chart");
    const ctx = c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);

    const entries = Object.values(all).sort((a,b)=> a.date.localeCompare(b.date)).slice(-14);
    if (entries.length === 0) return;

    const pad = 18;
    const w = c.width - pad*2;
    const h = c.height - pad*2;

    // axes baseline
    ctx.globalAlpha = 0.6;
    ctx.beginPath();
    ctx.moveTo(pad, pad+h);
    ctx.lineTo(pad+w, pad+h);
    ctx.strokeStyle = "#2b3a66";
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.globalAlpha = 1;

    // line
    const xs = entries.map((_,i)=> pad + (w*(i/(entries.length-1 || 1))));
    const ys = entries.map(e => pad + h * (1 - (e.score/100)));

    ctx.beginPath();
    ctx.moveTo(xs[0], ys[0]);
    for (let i=1;i<xs.length;i++) ctx.lineTo(xs[i], ys[i]);
    ctx.strokeStyle = "#2a66ff";
    ctx.lineWidth = 3;
    ctx.stroke();

    // points
    for (let i=0;i<xs.length;i++){
      ctx.beginPath();
      ctx.arc(xs[i], ys[i], 4, 0, Math.PI*2);
      ctx.fillStyle = "#e9eefc";
      ctx.fill();
    }
  }

  function computeAvg7(all){
    const entries = Object.values(all).sort((a,b)=> a.date.localeCompare(b.date));
    const last7 = entries.slice(-7);
    if (last7.length === 0) return "-";
    const avg = Math.round(last7.reduce((s,e)=>s+e.score,0)/last7.length);
    return String(avg);
  }

  function computeStreak(all){
    const entries = Object.keys(all).sort(); // dates
    if (entries.length === 0) return "-";
    let streak = 0;
    let d = new Date(todayISO());
    while(true){
      const key = d.toISOString().slice(0,10);
      if (all[key]) { streak++; d.setDate(d.getDate()-1); }
      else break;
    }
    return String(streak);
  }

  function exportCSV(all){
    const headers = ["date","score","grade","sleepHours","energy","mood","deepWork","aiMinutes","moneyMinutes","contentMinutes","speakingMinutes","englishMinutes","distractionMinutes","selfControl","win","break","tomorrow"];
    const rows = [headers.join(",")];
    const entries = Object.values(all).sort((a,b)=> a.date.localeCompare(b.date));
    for (const e of entries){
      const r = headers.map(h => {
        const v = (e[h] ?? "");
        const s = String(v).replaceAll('"','""');
        return `"${s}"`;
      }).join(",");
      rows.push(r);
    }
    const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "shamron_daily_score.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  // --- Init ---
  let currentDate = todayISO();
  $("dateLabel").textContent = currentDate;

  setValLabel("sleepHours","sleepHoursVal"," שעות");
  setValLabel("energy","energyVal","");
  setValLabel("mood","moodVal","");
  setValLabel("deepWork","deepWorkVal"," דקות");
  setValLabel("aiMinutes","aiMinutesVal"," דקות");
  setValLabel("moneyMinutes","moneyMinutesVal"," דקות");
  setValLabel("contentMinutes","contentMinutesVal"," דקות");
  setValLabel("speakingMinutes","speakingMinutesVal"," דקות");
  setValLabel("englishMinutes","englishMinutesVal"," דקות");
  setValLabel("distractionMinutes","distractionMinutesVal"," דקות");
  setValLabel("selfControl","selfControlVal","");

  function refreshSide(all){
    $("avg7").textContent = computeAvg7(all);
    $("streak").textContent = computeStreak(all);
    renderHistory(all);
    renderChart(all);
  }

  function renderResult(saved){
    $("scoreBig").textContent = saved.score;
    $("grade").textContent = saved.grade;
    $("summary").textContent = `קנס בריחות: ${saved.penalty} | נשמר ב: ${new Date(saved.savedAt).toLocaleString("he-IL")}`;
    const tips = tipsFromData(saved, {});
    $("tips").innerHTML = tips.map(t => `<li>${t}</li>`).join("");
  }

  function loadToday(){
    const all = loadAll();
    const d = all[currentDate];
    if (d) { fillForm(d); renderResult(d); }
    refreshSide(all);
  }

  $("loadBtn").addEventListener("click", loadToday);

  $("calcBtn").addEventListener("click", () => {
    const all = loadAll();
    const data = getFormData();
    const meta = computeScore(data);
    data.score = meta.score;
    data.penalty = meta.penalty;
    data.grade = gradeFromScore(meta.score);

    // Basic validation: force 1-liners to avoid "empty reflection"
    if (!data.win) data.win = "לא ציינתי ניצחון ברור היום.";
    if (!data.tomorrow) data.tomorrow = "מחר: 90 דק Deep Work על כסף.";

    all[currentDate] = data;
    saveAll(all);
    renderResult(data);
    refreshSide(all);
    alert("נשמר. מחר אתה ממשיך, לא מתאפס.");
  });

  $("exportBtn").addEventListener("click", () => exportCSV(loadAll()));

  $("resetBtn").addEventListener("click", () => {
    const ok = confirm("למחוק את כל הנתונים? זה בלתי הפיך.");
    if (!ok) return;
    localStorage.removeItem(KEY);
    $("scoreBig").textContent = "-";
    $("grade").textContent = "-";
    $("summary").textContent = "";
    $("tips").innerHTML = "";
    $("history").innerHTML = "<div class='muted'>אין נתונים עדיין.</div>";
    renderChart({});
    $("avg7").textContent = "-";
    $("streak").textContent = "-";
  });

  loadToday();
</script>
</body>
</html>